<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Insert title here</title>
</head>
<body>
	<video id="v1" width="120" height="90" autoplay muted></video>
	<video id="v2" width="120" height="90" autoplay></video>
	<video id="v3" width="120" height="90" autoplay></video></br>
	<label>roomNo : </label><input id="roomNo" type="text" />
	<button id="button" onclick="connect()">Join</button></br>
	<button id="button0" onclick="call()" disabled>Call</button>
	<button id="button1" onclick="addTrack1()" disabled>AddTrack1</button>
	<button id="button2" onclick="addTrack2()" disabled>AddTrack2</button>
	<div id="div"><p></div><br>
	<table><tr><td><div id="div2">Not connected</div></td></tr></table>
	<script src="/webjars/adapter.js"></script>
    <script src="/webjars/jquery/jquery.min.js"></script>
    <script src="/webjars/sockjs-client/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/stomp.min.js"></script>	  
	<script>
		roomNo.value = "";
		button.disabled = false;
		button2.disabled = true;
		
		var	count			= 0;
		var	deviceInfo;
		var constraints		= [];
		var streams			= [];
		
		var config = { iceServers: [{"urls":["turn:74.125.23.127:19305?transport=udp","turn:[2404:6800:4008:C02::7F]:19305?transport=udp","turn:74.125.23.127:443?transport=tcp","turn:[2404:6800:4008:C02::7F]:443?transport=tcp"],"username":"CK+QkccFEgYbJ1zsUDMYzc/s6OMTIICjBQ","credential":"nmwQuSOD5/KW4G0PQ9vZOgkVeMY="},{"urls":["stun:stun.l.google.com:19302"]}] };
		var signalingDelayMs = 0;
		
		var dc, pc = new RTCPeerConnection(config);
		pc.ontrack = e => {
			alert("aaaa");
			
			console.log('pc.ontrack');
			console.log('count = ' + count);
			
			if (count == 0)
				v2.srcObject = e.streams[0];
			else if (count == 1)
				v3.srcObject = e.streams[0];
			
			if (count > 1)
				v2.srcObject = e.streams[0];
			
			count++;
		};
		
    	pc.onicecandidate = e => {
			console.log('pc.onicecandidate');  
			console.log(e.candidate);  
			
			if (e.candidate)
				sendIce(e.candidate);
		};
		
		pc.oniceconnectionstatechange = () => {
			console.log('pc.oniceconnectionstatechange');
			console.log(pc.iceConnectionState);
			update(pc.iceConnectionState);
		};
		
		navigator.mediaDevices.enumerateDevices().then(e => {
			console.log('enumerateDevices'); 
			
			for (var i = 0; i < e.length; i++) {
				if (e[i].kind == 'videoinput')
					constraints.push({'video': {'deviceId' : e[i].deviceId ? {'exact' : e[i].deviceId} : undefined}});
			}
			
			console.log(constraints.length);
			
// 			if (constraints.length > 1) {
// 				var haveGum = navigator.mediaDevices.getUserMedia(constraints[1])
// 				.then(stream => streams[1] = stream)
// 				.then(() => navigator.mediaDevices.getUserMedia(constraints[0]))
// 				.then(stream => {
// 					v1.srcObject = streams[0] = stream;	
// 					pc.addStream(streams[0]);
// 				});	
				
				
// 			}
// 			else {
				var haveGum = navigator.mediaDevices.getUserMedia(constraints[0])
				.then(stream => {
					v1.srcObject = streams[0] = stream;
					
				});
// 			}
			
		}).catch(e => console.log(e));		
		
		var negotiating; // Chrome workaround
		
// 		pc.onnegotiationneeded = () => {
// 		  console.log('pc.onnegotiationneeded');
// 		  console.log(!!negotiating);
// 		  if (negotiating) return;
// 		  negotiating = true;
// 		};
		
		pc.onsignalingstatechange = () => {
			console.log('pc.onsignalingState');
			console.log(pc.signalingState || pc.readyState);
// 			console.log(pc.signalingState != "stable");
// 			negotiating = pc.signalingState != "stable";
		}
		
		var		stompClient	= null;
		
		function connect() {
		    var socket		= new SockJS('/rtc');
		    stompClient		= Stomp.over(socket);
		    stompClient.connect({}, function (frame) {
		        
		        console.log('Connected: ' + frame);
		        console.log('userName: ' + frame.headers['user-name']);

		        stompClient.subscribe('/user/queue/joinRoom', msg => {
		            var		room	= JSON.parse(msg.body);
		            
		            button.disabled = true;
		            
					if (room.attendees.length > 1) {
						button0.disabled = false;
					}
					else {
						button0.disabled = true;						
					}
		        });
		        
		        stompClient.subscribe('/user/queue/sdp', msg => {
		        	
		        	var desc = new RTCSessionDescription(JSON.parse(msg.body));
		        	
		        	if (desc.type == "offer") {
		        		console.log('offerSdp');
		        		console.log(desc);
		        		
			        	pc.setRemoteDescription(desc).then(() => pc.createAnswer())
				        .then(answer => pc.setLocalDescription(answer)).then(() => {
				        	
				        	console.log('Answer SDP');
				    		console.log(pc.localDescription);
				    		
				    		sendSdpAnswer(pc.localDescription);
				        }).catch(e => console.log(e));
			        }
		        	else {
		        		console.log('answerSdp');
				    	console.log(desc);
				    	  
				        pc.setRemoteDescription(desc).catch(e => console.log(e));		        		
		        	}
		        });
		        
		        stompClient.subscribe('/user/queue/ice', msg => {
		        	console.log('addIceCandidate');
		        	
// 		        	var	ice1	= new RTCIceCandidate(msg.body);
		        	var	ice2	= new RTCIceCandidate(JSON.parse(msg.body));
		        	
// 		        	console.log(ice1);
		        	console.log(ice2);
		        	
		        	pc.addIceCandidate(ice2).catch(e => console.log(e));
		        });
		        
		        stompClient.send("/app/joinRoom", {}, JSON.stringify({'roomNo': 10}));
		    });
		}
		
		function call() {
			button0.disabled = true;
			button1.disabled = false;
			
// 			dcInit(dc = pc.createDataChannel("chat"));
			makeOffer();
		}
		
		function makeOffer() {
			pc.addStream(streams[0]);
			
			pc.createOffer().then(d => pc.setLocalDescription(d))
			.then(() => {
				console.log('localDescription');
				console.log(JSON.stringify(pc.localDescription));
				  
				stompClient.send("/app/sendOffer", {}, JSON.stringify(pc.localDescription));
			})
			.catch(msg => {
				console.log('onnegotiationneeded');
				console.log(msg);
			});				
		}
		
		function disconnect() {
		    if (stompClient != null) {
		        stompClient.disconnect();
		    }
		    console.log("Disconnected");
		}

		function sendSdpOffer(sdp) {
		    stompClient.send("/app/sendOffer", {}, JSON.stringify(sdp));
		}
		
		function sendSdpAnswer(sdp) {
		    stompClient.send("/app/sendAnswer", {}, JSON.stringify(sdp));
		}
		
		function sendIce(ice) {
			stompClient.send("/app/sendIce", {}, JSON.stringify(ice));
		}
		
		function createOffer() {
		  console.log('createOffer()');	
			
		  button.disabled = true;
		  
		  dcInit(dc = pc.createDataChannel("chat"));
		};
		
		function addTrack1() {
		  console.log('addTrack111111111');
		  pc.addStream(streams[0]);
		  makeOffer();
		  
		  button2.disabled=false;
		  flipButton.disabled = false;
		  removeAddButton.disabled = false;
		}
		
		function addTrack2() {
		  console.log('addTrack222222222');
		  pc.addStream(streams[1]);
		  makeOffer();
		}		
		
		var flipped = 0;
		function flip() {
		  pc.getSenders()[0].replaceTrack(streams[flipped = 1 - flipped].getVideoTracks()[0])
		  .catch(msg => {
			  console.log('onnegotiationneeded');
			  console.log(msg);
		  });
		}
		
		function removeAdd() {
		  if ("removeTrack" in pc) {
			console.log('removeTrack exist');
			console.log(pc.getSenders());  
			
		    pc.removeTrack(pc.getSenders()[0]);
		    
		    console.log('removeAdd');
		    console.log(streams);
		    console.log(flipped);
		    
		    pc.addStream(streams[flipped = 1 - flipped]);
		  } else {
			console.log('removeTrack not in');
			console.log(pc.getSenders());
			console.log(flipped);
			
		    pc.removeStream(streams[flipped]);
		    pc.addStream(streams[flipped = 1 - flipped]);
		  }
		}
		
		var wait = ms => new Promise(resolve => setTimeout(resolve, ms));
		var update = msg => div2.innerHTML = msg;
		var log = msg => div.innerHTML += msg + "<br>";	
	</script>	
</body>
</html>